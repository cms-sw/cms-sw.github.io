<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>4.html</title>
    <script src="http://extra.amcharts.com/tutorials/loading-data/amcharts/amcharts.js" type="text/javascript"></script>
    <script src="http://extra.amcharts.com/tutorials/loading-data/amcharts/serial.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="http://jquery-csv.googlecode.com/git/src/jquery.csv.js"></script>

    <script type="text/javascript">
        function sortAtoZ(array) {
            array.sort(function(a, b) {
                if (a.date > b.date) {
                    return 1;
                }
                if (a.date < b.date) {
                    return -1;
                }
                // when a equal to b
                return 0;
            });
            return array
        }

        function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) {
                    return sParameterName[1];
                }
            }
        }

        Date.prototype.getWeek = function() {
            var date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            // Thursday in current week decides the year.
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            // January 4 is always in week 1.
            var week1 = new Date(date.getFullYear(), 0, 4);
            // Adjust to Thursday in week 1 and count number of weeks from date to week1.
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function getDateOfISOWeek(w, y) {
            var simple = new Date(y, 0, 1 + (w - 1) * 7);
            var dow = simple.getDay();
            var ISOweekStart = simple;
            if (dow <= 4)
                ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else
                ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());

            var date = ISOweekStart.getFullYear() + "-" + ('0' + (ISOweekStart.getMonth() + 1)).slice(-2) + "-" + ('0' + ISOweekStart.getDate()).slice(-2);
            return date;
        }

        
        var from = getUrlParameter('from');
        var to = getUrlParameter('to');
        var barType = getUrlParameter('type');


        //var selectDropdownMenu2 = document.getElementById("period");
        //var valueFromDropdownMenu = selectDropdownMenu2.options[selectDropdownMenu2.selectedIndex].value;
        //console.log("reiksme=" + valueFromDropdownMenu2); 


        if (from == undefined) {
            from = "01/06/2013";
        }
        if (to == undefined) {
            var currentdate = new Date();
            var to = 31 + "/" + (currentdate.getMonth() + 1) + "/" + currentdate.getFullYear();
        }

        console.log("from=" + from +" to=" + to );
        var dataSets = {};
        dataSets['months'] = {};
        dataSets['weeks'] = {};
        dataSets['days'] = {};
        dataSets['months']['all'] = [];
        dataSets['weeks']['all'] = [];
        dataSets['days']['all'] = [];
        var graph;
        var graphType = "column";
        var maxCandlesticks = 100;
        var test = [];
        var test2 = [];
        var test3 = [];
        var statistics = {};
        var chartDataDays = [];
        var chartDataWeeks = [];
        var chartDataMonths = [];
        var chartData = [];
        var chartDataTypeStatus = "months";
        var chartDataTypeCategory = "all";
        var allowedToChange = true;

        AmCharts.ready(function() {
            // first parse data string
            // parseData();

            // SERIAL CHART
            chart = new AmCharts.AmSerialChart();
            chart.pathToImages = "http://www.amcharts.com/lib/images/"
            chart.dataProvider = dataSets['months']['all'];
            chart.categoryField = "date";
            // listen for dataUpdated event ad call "zoom" method then it happens
            chart.addListener('dataUpdated', zoomChart);
            // listen for zoomed event andcall "handleZoom" method then it happens
            chart.addListener('zoomed', handleZoom);

            // AXES
            // category
            var categoryAxis = chart.categoryAxis;
            //categoryAxis.labelRotation = 90;
            categoryAxis.parseDates = true; // as our data is date-based, we set this to true
            categoryAxis.minPeriod = "MM"; // our data is daily, so we set minPeriod to "DD"
            categoryAxis.dashLength = 1;
            categoryAxis.tickLenght = 1;
            categoryAxis.inside = false;
            categoryAxis.offset = 0;
            //categoryAxis.title = "test";

            // value
            var valueAxis = new AmCharts.ValueAxis();
            //valueAxis.maximum = 570;
            valueAxis.dashLength = 1;
            valueAxis.axisAlpha = 1;
            valueAxis.title = "Pull requests per month";

            chart.addValueAxis(valueAxis);

            // GRAPH
            graph = new AmCharts.AmGraph();
            graph.title = "Price:";
            // as candlestick graph looks bad when there are a lot of candlesticks, we set initial type to "line"
            graph.type = "column";
            // graph colors
            graph.lineColor = "#7f8da9";
            graph.fillColors = "#009900";
            graph.negativeLineColor = "#db4c3c";
            graph.negativeFillColors = "#db4c3c";
            graph.fillAlphas = 1;
            graph.balloonText = "Date: <b> [[date]]</b><br />Value:<b>[[visits]]</b>";
            // this one is for "line" graph type
            graph.valueField = "visits";
            chart.addGraph(graph);

            // CURSOR
            var chartCursor = new AmCharts.ChartCursor();
            chartCursor.cursorPosition = "mouse";
            chartCursor.categoryBalloonDateFormat = "YYYY-MMMM-DD";
            chart.addChartCursor(chartCursor);

            // SCROLLBAR
            var chartScrollbar = new AmCharts.ChartScrollbar();
            chartScrollbar.scrollbarHeight = 30;
            chartScrollbar.graph = graph; // as we want graph to be displayed in the scrollbar, we set graph here
            chartScrollbar.graphType = "column"; // we don't want candlesticks to be displayed in the scrollbar
            chartScrollbar.autoGridCount = true;
            chartScrollbar.color = "#000";
            chart.addChartScrollbar(chartScrollbar);

            // WRITE
            chart.write("chartdiv");
			loadCSV("/cms-sw.github.io/data/stats/pr-stats.csv");

        });

        function loadCSV(file) {
            if (window.XMLHttpRequest) {
                // IE7+, Firefox, Chrome, Opera, Safari
                var request = new XMLHttpRequest();
            } else {
                // code for IE6, IE5
                var request = new ActiveXObject('Microsoft.XMLHTTP');
            }
            // load
            request.open('GET', file, false);
            request.send();
			
			var data = request.responseText;
			//replace UNIX new lines
            data = data.replace(/\r\n/g, "\n");
            //replace MAC new lines
            data = data.replace(/\r/g, "\n");
            //split into rows
            var rows = data.split("\n");

            parseCSV(rows);
            parseCSV2(rows);
            parseCSV3(rows);
            chart.validateData();
            zooooooom(stringToDate(from), stringToDate(to));
            if ((barType == "days") || (barType == "weeks") || (barType == "months")) {
                change(barType, chartDataTypeCategory);
                changeType();
            }
     //       console.log(dataSets['months']['all']);
        }

        function parseCSV(rows) {
            for (var i = 1; i < rows.length; i++) {
                if (rows[i]) {
                    var column = rows[i].split(",");

                    var date = new Date(column[0] * 1000);
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();
                    var myDateStringDays = date.getFullYear() + "-" + ('0' + (date.getMonth() + 1)).slice(-2) + "-" + ('0' + day).slice(-2);
                    if (statistics[myDateStringDays] == null) {
                        statistics[myDateStringDays] = 1;
                    } else {
                        statistics[myDateStringDays]++;
                    }
                }

            }

            jQuery.each(statistics, function (i, val) {
                var dataObject = {
                    date: i,
                    visits: val
                };
                test.push(dataObject);
            });

            test = sortAtoZ(test);

            jQuery.each(test, function(i, val) {
                var dataObject = {
                    date: val.date,
                    visits: val.visits
                };

                dataSets['days']['all'].push(dataObject);

            });
        }

        function parseCSV2(rows) {

            //console.log(rows.length);
            // loop through all rows
            statistics = {};
            statistics['months'] = {};
            statistics['months']['all'] = {};
            statistics['months']['alca'] = {};
            for (var i = 1; i < rows.length; i++) {
                // this line helps to skip empty rows
                if (rows[i]) {
                    // our columns are separated by comma
                    var column = rows[i].split(",");

                    // column is array now
                    // first item is date
                    //  var date = column[0];
                    var labelStatus = column[8];
                    var date = new Date(column[0] * 1000);
                    // second item is value of the second column
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();


                    var value = column[1];

                    var myDateStringMonths = date.getFullYear() + "-" + ('0' + (date.getMonth() + 1)).slice(-2);

                    if ( statistics['months']['all'][myDateStringMonths] == null) {
                        statistics['months']['all'][myDateStringMonths] = 1;
                    } else {
                        statistics['months']['all'][myDateStringMonths] ++;
                    }

                    if (labelStatus[0] !== "N") {
                        if ( statistics['months']['alca'][myDateStringMonths] == null) {
                            statistics['months']['alca'][myDateStringMonths] = 1;
                        } else {
                            statistics['months']['alca'][myDateStringMonths] ++;
                        }
                    }
                }
            }
           //console.log(dataSets['months']['all']);
            /*
             jQuery.each( statistics['months']['all'], function(i, val) {
                var dataObject = {
                    date: i,
                    visits: val
                };
                tempArray.push(dataObject);
            });

            tempArray = sortAtoZ(tempArray);
*/
            var tempArray = processedDataAndSorted(statistics['months']['all']);

            jQuery.each(tempArray, function(i, val) {
                var dataObject = {
                    date: val.date,
                    visits: val.visits
                };

                dataSets['months']['all'].push(dataObject);
            });

            var tempArray = processedDataAndSorted(statistics['months']['alca']);
            dataSets['months']['alca'] = [];
            jQuery.each(tempArray, function(i, val) {
                var dataObject = {
                    date: val.date,
                    visits: val.visits
                };

                dataSets['months']['alca'].push(dataObject);
            });

            console.log(dataSets['months']['alca']);


        }

        function processedDataAndSorted(array) {
            var tempArray = [];
            var tempArray2 = [];
            jQuery.each(array, function(i, val) {
                var dataObject = {
                    date: i,
                    visits: val
                };
                tempArray.push(dataObject);
            });
            tempArray = sortAtoZ(tempArray);
            return tempArray
        }

        function parseCSV3(rows) {

            // loop through all rows
            statistics = {};
            for (var i = 1; i < rows.length; i++) {
                // this line helps to skip empty rows
                if (rows[i]) {
                    // our columns are separated by comma
                    var column = rows[i].split(",");


                    //  var month = date.getMonth() + 1;
                    //  var day = date.getDate();


                    // var value = column[0];
                    var date = new Date(column[0] * 1000);
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();

                    //              console.log(year + "-" + month + "-" + day);

                    var dateWeek = date.getWeek();
                    var dateDay = date.getDay();
                    if ((dateWeek == 1) && (dateDay < 4) && (month == 12)) {
                        year++;
                    }

                    var myDateStringWeeks = year.toString() + " Week" + dateWeek;
                    if (statistics[myDateStringWeeks] == null) {
                        statistics[myDateStringWeeks] = 1;
                    } else {
                        statistics[myDateStringWeeks] ++;
                    }

                }
            }

            //       console.log(statistics);
            //       console.log(JSON.stringify(statistics));

            jQuery.each(statistics, function(i, val) {
                var year = i.substring(0, 4);
                var weekNumber = i.substring(9, i.length)
                    //console.log("year"+year+" weeknumber=" + weekNumber);
                dateGotFromWeek = getDateOfISOWeek(weekNumber, year);
                var dataObject = {
                    date: dateGotFromWeek,
                    visits: val
                };
                // add object to chartData array
                //console.log(dataObject);
                test3.push(dataObject);
                //  chartData.push(dataObject);
                /*
                    processedDataArray.push({
                        "Date": i,
                        "Pull request": val
                        //"Year": (i.substring(0, 4))
                    });*/
            });

            test3 = sortAtoZ(test3);

            jQuery.each(test3, function(i, val) {
                var dataObject = {
                    date: val.date,
                    visits: val.visits
                };

                dataSets['weeks']['all'].push(dataObject);
            });
            //console.log(barType);
            //if ((barType == "days") || (barType == "weeks") || (barType == "months")){
            //  change(barType);
            //}
        }



        // this method is called when chart is first inited as we listen for "dataUpdated" event
        function zoomChart() {
            // different zoom methods can be used - zoomToIndexes, zoomToDates, zoomToCategoryValues
            //console.log("dataSets['months']['all'] " + dataSets['months']['all'].length);
            //console.log("chartData.length " + chartData.length);
            //   f
            //chart.zoomToIndexes(15, 20);

        }

        // this methid is called each time the selected period of the chart is changed
        function handleZoom(event) {
            //console.log(event);
            var startDate = event.startDate;
            var endDate = event.endDate;
            if (allowedToChange) {
                document.getElementById("startDate").value = AmCharts.formatDate(startDate, "DD/MM/YYYY");
                document.getElementById("endDate").value = AmCharts.formatDate(endDate, "DD/MM/YYYY");
            }


            //  if ((allowedToChange) || (valueFromDropdownMenu !== getUrlParameter['type'])) {

            //alert(window.location.pathname);
            //window.history.pushState('page2', 'Title', '/page2.php');

            // as we also want to change graph type depending on the selected period, we call this method
            changeGraphType(event);
        }

        // changes graph type to line/candlestick, depending on the selected range
        function changeGraphType(event) {
            //console.log(event);
            var startIndex = event.startIndex;
            var endIndex = event.endIndex;
            // console.log("startIndex=" + startIndex + "endIndex=" + endIndex);
            var startDate = document.getElementById("startDate").value;
            startDate = new Date(startDate.substring(3, 5) + "/" + startDate.substring(0, 2) + "/" + startDate.substring(6, 10));
            var endDate = document.getElementById("endDate").value;
            endDate = new Date(endDate.substring(3, 5) + "/" + endDate.substring(0, 2) + "/" + endDate.substring(6, 10));
            //alert(endDate);

            var timeDiffBetweenTwoDates = Math.abs(endDate.getTime() - startDate.getTime());
            var daysBetweenTwoDates = Math.ceil(timeDiffBetweenTwoDates / (1000 * 3600 * 24));

            if (allowedToChange) {
                if ((chartDataTypeStatus !== "days") && (daysBetweenTwoDates < 60)) {
                    change('days', chartDataTypeCategory);
                    chartDataTypeStatus = "days";
                } else if ((chartDataTypeStatus !== "weeks") && (daysBetweenTwoDates < 120) && (daysBetweenTwoDates > 62)) {
                    change('weeks', chartDataTypeCategory);
                    chartDataTypeStatus = "weeks";
                } else if ((chartDataTypeStatus !== "months") && (daysBetweenTwoDates > 122)) {
                    change('months', chartDataTypeCategory);
                    chartDataTypeStatus = "months";

                }

                if (allowedToChange) {
                    var selectDropdownMenu = document.getElementById("period");
                    var valueFromDropdownMenu = selectDropdownMenu.options[selectDropdownMenu.selectedIndex].value;
                    //console.log(valueFromDropdownMenu);
                    window.history.pushState("object", "Title", "/cms-sw.github.io/stats/4.html?from=" + document.getElementById("startDate").value + "&to=" + document.getElementById("endDate").value + "&type=" + valueFromDropdownMenu);
                }

            }

        }

        function change(value, category) {

            var startDateString = document.getElementById("startDate").value;
            var endDateString = document.getElementById("endDate").value;
            var startDate = stringToDate(startDateString);
            var endDate = stringToDate(endDateString);

            //chart.dataProvider = null;
            //chart.chartData = null;
            //chart.validateData();
            //chart.validateNow();
            var categoryAxis = chart.categoryAxis;

            if (value == "months") {
                chart.dataProvider = dataSets['months']['all'];
                chart.valueAxes[0].title = "Pull requests per month";
                categoryAxis.minPeriod = "MM";
                $('#period').val(value);
            } else if (value == "weeks") {
                chart.dataProvider = dataSets['weeks']['all'];
                chart.valueAxes[0].title = "Pull requests per week";
                categoryAxis.minPeriod = "WW";
                $('#period').val(value);
            } else if (value == "days") {
                chart.dataProvider = dataSets['days']['all'];
                chart.valueAxes[0].title = "Pull requests per day";
                categoryAxis.minPeriod = "DD";
                $('#period').val(value);
            }

            // categoryAxis.parseDates = false; // as our data is date-based, we set this to true
            categoryAxis.inside = false;

            allowedToChange = false;
            chart.validateNow();
            chart.validateData();
           // console.log("startDate=" + startDate + " endDate=" + endDate );
            zooooooom(startDate, endDate);

            allowedToChange = true;
        }


        // this method converts string from input fields to date object
        function stringToDate(str) {
            var dArr = str.split("/");
            var date = new Date(Number(dArr[2]), Number(dArr[1]) - 1, dArr[0]);
            return date;
        }

        // this method is called when user changes dates in the input field
        function changeZoomDates() {
            var startDateString = document.getElementById("startDate").value;
            var endDateString = document.getElementById("endDate").value;
            var startDate = stringToDate(startDateString);
            var endDate = stringToDate(endDateString);
            zooooooom(startDate, endDate);
        }

        function zooooooom(a, b) {
            //console.log("startDate="+a+" endDate=" + b);
            chart.zoomToDates(a, b)
        }


        function getComboA(sel) {
            var value = sel.value;
            change(value, chartDataTypeCategory);
            changeType();
        }

        function getComboB(sel) {
            var cat = sel.value;
            change(chartDataTypeStatus, cat);
            changeType();
        }

        function changeType() {
            var selectDropdownMenu = document.getElementById("period");
            var valueFromDropdownMenu = selectDropdownMenu.options[selectDropdownMenu.selectedIndex].value;
				window.history.pushState("object", "Title", "/cms-sw.github.io/stats/4.html?from=" + document.getElementById("startDate").value + "&to=" + document.getElementById("endDate").value + "&type=" + valueFromDropdownMenu);
        }        




    </script>
</head>


<body>
    <div id="chartdiv" style="width:100%; height:400px;"></div>
    <div style="float:right;margin-right:20px;">
        <input onChange="changeZoomDates()" style="width:100px; text-align:center" type="text" id="startDate">
        <input onChange="changeZoomDates()" style="width:100px; text-align:center" type="text" id="endDate">
    </div>
Choose graduality:
    <select id="period" onchange="getComboA(this)">
        <option value="months">Months</option>
        <option value="weeks">Weeks</option>
        <option value="days">Days</option>
    </select>
    <!--Choose category:
    <select id="category" onchange="getComboB(this)">
        <option value="all">All categories</option>
        <option value="alca">alca</option>
        <option value="analysis">analysis</option>
        <option value="db">db</option>
    </select>-->

   <!-- <input type="button" value="bla" onClick="zooooooom(stringToDate(from), stringToDate(to));" />-->
</body>
</html>