<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>amCharts examples</title>
    <script src="http://extra.amcharts.com/tutorials/loading-data/amcharts/amcharts.js" type="text/javascript"></script>
    <script src="http://extra.amcharts.com/tutorials/loading-data/amcharts/pie.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>


    <script type="text/javascript">
        // INITIALIZE
        var chart;
        var categoryId = 0;
        var categories = {};
        categories[0] = "alca";
        categories[1] = "analysis";
        categories[2] = "db";
        categories[3] = "daq";
        categories[4] = "docs";
        categories[5] = "dqm";
        categories[6] = "core";
        categories[7] = "fastsim";
        categories[8] = "generators";
        categories[9] = "geometry";
        categories[10] = "l1";
        categories[11] = "operations";
        categories[12] = "pdmv";
        categories[13] = "reconstruction";
        categories[14] = "simulations";
        categories[15] = "tests";
        categories[16] = "visualization";




        var chartData = [];
        for (var i = 0; i < 18; i++) {
            chartData[i] = [];
        }
        chartData['category'] = [];
        var totalPr = 0;
        var statistics = {};
        for (var i = 0; i < 18; i++){
            statistics[i] = {}
            statistics[i]["less than a minute"] = 0;
            statistics[i]["1 minute to an hour"] = 0;
            statistics[i]["1 hour to a day"] = 0;
            statistics[i]["1 day to a week"] = 0;
            statistics[i]["1 week to 2 weeks"] = 0;
            statistics[i]["2 weeks to a month"] = 0;
            statistics[i]["1 month to a two month"] = 0;
            statistics[i]["more than two month"] = 0;
        }
        var idList = [];
        for (var i = 0; i < 18; i++) {
            idList[i] = [];
            idList[i]["less than a minute"] = [];
            idList[i]["1 minute to an hour"] = [];
            idList[i]["1 hour to a day"] = [];
            idList[i]["1 day to a week"] = [];
            idList[i]["1 week to 2 weeks"] = [];
            idList[i]["2 weeks to a month"] = [];
            idList[i]["1 month to a two month"] = [];
            idList[i]["more than two month"] = [];
        }
        var info = [];
        for (var i = 0; i < 18; i++) {
            info[i] = {};
            info[i]["totalPR"] = 0;
        }
        var currentTimeInSeconnds = Date.now() / 1000;

        AmCharts.ready(function () {
            // PIE CHART
			loadCSV("/cms-sw.github.io/data/stats/pr-stats.csv");


            chart = new AmCharts.AmPieChart();
            chart.dataProvider = chartData[categoryId];
            chart.titleField = "period";
            chart.valueField = "value";
            chart.outlineColor = "#FFFFFF";
            chart.outlineAlpha = 0.8;
            chart.outlineThickness = 2;
            chart.balloonText = "[[title]]<br>PR count:<span style='font-size:14px'><b> [[value]]</b></span> ([[percents]]%)";
            // this makes the chart 3D
            chart.depth3D = 15;
            chart.angle = 30;

            chart.borderAlpha = 1;

            // Title
            chart.addTitle("Not merged or closed Pull Requests (" + info[categoryId]["totalPR"] + ")");
            // LEGEND
            legend = new AmCharts.AmLegend();
            legend.align = "center";
            legend.markerType = "circle";
            chart.addLegend(legend);


            // AN EVENT
            chart.addListener("clickSlice", function (event) {
                var title = event.dataItem.title;

                if (event.dataItem.dataContext.id != undefined) {

                }
                else {
                    //console.log(event);
                    console.log(event.dataItem.title);
                    var categoryName = title.slice(10, title.length);
                    var catId = getCategoryId(categoryName);

                    changeChartCategory(parseInt(catId)+1);
                    console.log(categoryName);
                    //writeTable(title);
                }
            });

            // WRITE
            chart.write("chartdiv");
            chart.validateNow();
        });

        function loadCSV(file) {
            if (window.XMLHttpRequest) {
                // IE7+, Firefox, Chrome, Opera, Safari
                var request = new XMLHttpRequest();
            } else {
                // code for IE6, IE5
                var request = new ActiveXObject('Microsoft.XMLHTTP');
            }
            // load
            request.open('GET', file, false);
            request.send();

            var data = request.responseText;
            //replace UNIX new lines
            data = data.replace(/\r\n/g, "\n");
            //replace MAC new lines
            data = data.replace(/\r/g, "\n");
            //split into rows
            var rows = data.split("\n");

            parseCSV(rows);
            getAllCategoryData();
            console.log(info);

        }

        function parseCSV(rows) {

            for (var i = 1; i < rows.length; i++) {
                if (rows[i]) {
                    var column = rows[i].split(",");

                    var creationTime = column[0];
                    var mergeTime = column[1];
                    var id = column[2];
                    var isPr = column[3];
                    var closed = column[5];
                    var labelStatus = column[8];

                    var date = new Date(column[0] * 1000);
                    // second item is value of the second column
                    var year = date.getFullYear();
                    var month = date.getMonth() + 1;
                    var day = date.getDate();

                    if ((isPr == "1") && (closed == "0") )  {
                        var pullRequestAlreadyOpenedForSeconds = currentTimeInSeconnds - creationTime;
                        info[0]["totalPR"] += 1;
                        if (pullRequestAlreadyOpenedForSeconds <= 60) { //sec
                            statistics[0]["less than a minute"]++;
                            idList[0]["less than a minute"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60) { //sec * min
                            statistics[0]["1 minute to an hour"]++;
                            idList[0]["1 minute to an hour"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24) { // sec * min * hours
                            statistics[0]["1 hour to a day"]++;
                            idList[0]["1 hour to a day"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 7) { // sec * min * hours * 7
                            statistics[0]["1 day to a week"]++;
                            idList[0]["1 day to a week"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 14) {
                            statistics[0]["1 week to 2 weeks"]++;
                            idList[0]["1 week to 2 weeks"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 30) {
                            statistics[0]["2 weeks to a month"]++;
                            idList[0]["2 weeks to a month"].push(id);
                        } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 60) {
                            statistics[0]["1 month to a two month"]++;
                            idList[0]["1 month to a two month"].push(id);
                        } else {
                            statistics[0]["more than two month"]++;
                            idList[0]["more than two month"].push(id);
                        }
                    }

                    for (var o = 0; o < 17; o++)
                    {
                        proceedCategoryData(column, o);
                    }
                }
            }

            for (var counter = 0; counter < 18; counter++) {
                var tempArray = [];
                jQuery.each(statistics[counter], function (i, val) {
                    var dataObject = {
                        date: i,
                        value: val
                    };
                    tempArray.push(dataObject);
                });

                tempArray.sort(function (a, b) {
                    if (a.date > b.date) {
                        return 1;
                    }
                    if (a.date < b.date) {
                        return -1;
                    }
                    // when a equal to b
                    return 0;
                });

                jQuery.each(tempArray, function (i, val) {
                    var dataObject = {
                        period: val.date,
                        value: val.value
                    };

                    chartData[counter].push(dataObject);
                });

            }
        }

        function writeTable(sliceName) {
            jQuery.each(idList[categoryId][sliceName], function (i, val) {
                var PRid = idList[categoryId][sliceName][i];

                var string = "<tr><td>" + "<a href='https://github.com/cms-sw/cmssw/pull/" + PRid + "'>"+PRid+"</td><td>"+sliceName+"</td></tr>"
                $('#myTable > tbody:last').append(string);
            });
            //$('#myTable > tbody:last').append('<tr><td>bla</td></tr>');

        }
       // console.log(statistics);
        function proceedCategoryData(column, categoryNumber) {
            var creationTime = column[0];
            var mergeTime = column[1];
            var id = column[2];
            var isPr = column[3];
            var closed = column[5];
            var labelStatus = column[8];

            var date = new Date(column[0] * 1000);
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            var day = date.getDate();

            var categoryTotal = 0;
            var categoryName = categoryNumber+1;
//            var categoryName = categoryNumber+1;
            if ((isPr == "1") && (closed == "0") && ((labelStatus[categoryName] == "P"))) {
                var pullRequestAlreadyOpenedForSeconds = currentTimeInSeconnds - creationTime;
                if (pullRequestAlreadyOpenedForSeconds <= 60) { //sec
                    statistics[categoryName]["less than a minute"]++;
                    idList[categoryName]["less than a minute"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60) { //sec * min
                    statistics[categoryName]["1 minute to an hour"]++;
                    idList[categoryName]["1 minute to an hour"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24) { // sec * min * hours
                    statistics[categoryName]["1 hour to a day"]++;
                    idList[categoryName]["1 hour to a day"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 7) { // sec * min * hours * 7
                    statistics[categoryName]["1 day to a week"]++;
                    idList[categoryName]["1 day to a week"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 14) {
                    statistics[categoryName]["1 week to 2 weeks"]++;
                    idList[categoryName]["1 week to 2 weeks"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 30) {
                    statistics[categoryName]["2 weeks to a month"]++;
                    idList[categoryName]["2 weeks to a month"].push(id);
                } else if (pullRequestAlreadyOpenedForSeconds <= 60 * 60 * 24 * 60) {
                    statistics[categoryName]["1 month to a two month"]++;
                    idList[categoryName]["1 month to a two month"].push(id);
                } else {
                    statistics[categoryName]["more than two month"]++;
                    idList[categoryName]["more than two month"].push(id);
                }
                info[categoryName]["totalPR"] += 1;
            }
        }

        function changeChartCategory(id){
            console.log(id);
            chart.dataProvider = chartData[id];
            chart.titles[0].text = "Category: " + getCategoryName(id-1) +  ". Not closed/merged pull requests (" + info[id]["totalPR"] + ")";
            chart.validateData();
        }

        function initChart() {
            chart.dataProvider = chartData['category'];
            var tempTotal = 0;
            for (var i = 0; i < 17; i++) {
                tempTotal += info[i+1]['totalPR'];
            }
            chart.titles[0].text = "Categories chart if PR has status pending or started "+ tempTotal;
            chart.validateData();
            console.log(info);
        }

        function getAllCategoryData() {
            console.log(info);
            for (i = 1; i < info.length; i++) {

                var dataObject = {
                    period: "Category: " + getCategoryName(i-1),
                    value: info[i]["totalPR"]
                };

                chartData['category'].push(dataObject);
            }
        }

        function getCategoryName(id) {

            return categories[id];
        }

        function getCategoryId(categoryName) {
            console.log(categories)
            var categoryByName = [];
            jQuery.each(categories, function (i, val) {
                categoryByName[val] = i;
            });
            return categoryByName[categoryName];
        }
    </script>


</head>

<body>
<div id="chartdiv" style="width: 100%; height: 500px;"></div>

<input type="button" value="All categories" onclick="initChart();"/>

<!--<table id="myTable" border="1">
    <tbody>
    <tr>
        <th>Id</th>
        <th>Type</th>
    </tr>
    </tbody>
</table>
--></body>

</html>